<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Homepage with dashboard, resources, and account management for users.">
    <meta name="keywords" content="homepage, dashboard, resources, account, user, web">
    <title>Account Page</title>
    <link rel="stylesheet" href="/dashboard/base.css">
</head>
<body>
     <header>
        <div class="header-flex">
            <div class="logo">
                <img src="../dashboard/logo.png" alt="Site Logo" height="80" width="80" onerror="this.onerror=null;this.src='https://via.placeholder.com/80x80?text=Logo';">
            </div>
            <h1 class="site-heading">Account</h1>
        </div>
    </header>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-user">
                <div class="user-info user-dropdown">
                    <span class="user-label">Logged in as</span>
                    <div class="dropdown">
                        <a href="#" class="dropbtn user-name user-dropdown-btn">{{ username }} ▼</a>
                        <div class="dropdown-content user-dropdown-content">
                            <a href="{{ url_for('account') }}">Account</a>
                            <a href="/logout">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('homepage') }}">Home</a></li>
                    <li class="dropdown">
                        <a href="{{ url_for('dashboard') }}" class="dropbtn">Dashboard ▼</a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('alerts') }}">Alerts</a>
                            <a href="{{ url_for('leaks') }}">Leaks</a>
                            <a href="{{ url_for('reports') }}">Reports</a>
                            <a href="{{ url_for('risk_analysis') }}">Risk Analysis</a>
                        </div>
                    </li>
                    <li><a href="{{ url_for('resources_route') }}">Resources</a></li>
                </ul>
            </nav>
        </aside>
        <main>
            <section id="account">
                <h2>Account</h2>
                <section class="account-item">
                    <p>Manage your profile and settings here.</p>
                    <form action="/logout" method="get" style="margin-top: 20px;">
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>
                    <button id="delete-account-btn" class="logout-btn" style="background:#c00; color:#fff; margin-top:20px;">Delete Account</button>
                    <script>
                    document.getElementById('delete-account-btn').onclick = function(e) {
                        e.preventDefault();
                        if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
                        fetch('/api/account/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'deleted') {
                                alert('Your account has been deleted.');
                                window.location.href = '/register';
                            } else {
                                alert('Error: ' + (data.message || 'Could not delete account.'));
                            }
                        })
                        .catch(() => alert('Network error. Please try again.'));
                    };
                    </script>

                    <!-- Reset Password Section -->
                    <hr style="margin: 2em 0;">
                    <h3>Change Password</h3>
                    <form id="reset-password-form" style="margin-top: 1em;">
                        <label for="reset-new-password">New Password</label>
                        <input type="password" id="reset-new-password" name="new_password" required placeholder="Enter new password" style="margin-bottom: 1em;">
                        <button type="submit" class="logout-btn" style="background:#007bff; color:#fff;">Change Password</button>
                    </form>
                    <div id="reset-password-message" style="margin-top:1em;color:#c00;"></div>
                    <script>
                    document.getElementById('reset-password-form').onsubmit = function(e) {
                        e.preventDefault();
                        const newPassword = document.getElementById('reset-new-password').value;
                        const msgDiv = document.getElementById('reset-password-message');
                        msgDiv.textContent = '';
                        fetch('/api/reset_password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_password: newPassword })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                msgDiv.style.color = '#080';
                                msgDiv.textContent = 'Password changed successfully.';
                            } else {
                                msgDiv.style.color = '#c00';
                                msgDiv.textContent = data.message || 'Password change failed.';
                            }
                        })
                        .catch(() => {
                            msgDiv.style.color = '#c00';
                            msgDiv.textContent = 'Network error. Please try again.';
                        });
                    };
                    </script>
                </section>
            </section>
        </main>
    </div>
</body>
</html>
