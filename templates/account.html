<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Homepage with dashboard, resources, and account management for users.">
    <meta name="keywords" content="homepage, dashboard, resources, account, user, web">
    <title>Account Page</title>
    <link rel="stylesheet" href="/dashboard/new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="{{ url_for('homepage') }}" data-tooltip="Home"><i class="fa-regular fa-house"></i></a></li>
                    <li><a href="{{ url_for('leaks') }}" data-tooltip="Leaks"><i class="fa-solid fa-spider"></i></a></li>
                    <li><a href="{{ url_for('alerts') }}" data-tooltip="Alerts"><i class="fa-regular fa-bell"></i></a></li>
                    <li><a href="{{ url_for('dashboard') }}" data-tooltip="Dashboard"><i class="fa-regular fa-chart-bar"></i></a></li>
                    <li><a href="{{ url_for('reports') }}" data-tooltip="Reports"><i class="fa-regular fa-file-lines"></i></a></li>
                    <li><a href="{{ url_for('resources_route') }}" data-tooltip="Resources"><i class="fa-solid fa-book-open"></i></a></li>
                    <li><a class="active" href="{{ url_for('account') }}" data-tooltip="Account"><i class="fa-regular fa-circle-user"></i></a></li>
                    <li><a href="{{ url_for('config') }}" data-tooltip="Settings"><i class="fa-solid fa-gear"></i></a></li>
                </ul>
            </nav>
        </aside>
        <main>
            <div class="section-heading">
                <h2>Account</h2>
            </div>
            <section id="account">
                <section class="account-item">
                    <p>Manage your profile and settings here.</p>
                    <form action="/logout" method="get" style="margin-top: 20px;">
                        <button type="submit" class="logout-btn" id="logout">Logout</button>
                    </form>
                    <button id="delete-account-btn" class="logout-btn">Delete Account</button>
                    <script>
                    document.getElementById('delete-account-btn').onclick = function(e) {
                        e.preventDefault();
                        if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
                        fetch('/api/account/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            // Ensure the session cookie is sent for same-origin requests
                            credentials: 'same-origin',
                            body: JSON.stringify({ csrf_token: '{{ csrf_token() }}' })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'deleted') {
                                alert('Your account has been deleted.');
                                window.location.href = '/register';
                            } else {
                                alert('Error: ' + (data.message || 'Could not delete account.'));
                            }
                        })
                        .catch(() => alert('Network error. Please try again.'));
                    };
                    </script>

                    <!-- Reset Password Section -->
                    <hr style="margin: 2em 0;">
                    <h3>Change Password</h3>
                    <form id="reset-password-form" style="margin-top: 1em;">
                        <label for="reset-new-password">New Password</label>
                        <input type="password" id="reset-new-password" name="new_password" required placeholder="Enter new password" style="margin-bottom: 1em;">
                        <button type="submit" class="logout-btn" id="password">Change Password</button>
                    </form>
                    <div id="reset-password-message" style="margin-top:1em;color:#c00;"></div>
                    <script>
                    document.getElementById('reset-password-form').onsubmit = function(e) {
                        e.preventDefault();
                        const newPassword = document.getElementById('reset-new-password').value;
                        const msgDiv = document.getElementById('reset-password-message');
                        msgDiv.textContent = '';
                        fetch('/api/reset_password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_password: newPassword })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                msgDiv.style.color = '#080';
                                msgDiv.textContent = 'Password changed successfully.';
                            } else {
                                msgDiv.style.color = '#c00';
                                msgDiv.textContent = data.message || 'Password change failed.';
                            }
                        })
                        .catch(() => {
                            msgDiv.style.color = '#c00';
                            msgDiv.textContent = 'Network error. Please try again.';
                        });
                    };
                    </script>
                </section>
            </section>
        </main>
    </div>
</body>
</html>
